<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    
    /* åº§ä½æŒ‰éˆ• */
    .seat-button {
      width: 58px; height: 58px; font-size: 12px;
      @media (max-width: 370px) { width: 50px; height: 50px; font-size: 10px; }
      @media (min-width: 640px) { width: 64px; height: 64px; font-size: 12px; }
      
      display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
      border-radius: 8px; 
      @media (min-width: 640px) { border-radius: 12px; }
      
      cursor: pointer; transition: all 0.1s ease; font-weight: 700; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      -webkit-tap-highlight-color: transparent; user-select: none;
    }
    .seat-button:active { transform: scale(0.92); } 
    .seat-button:hover { 
      @media (min-width: 640px) { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    }
    
    /* ç‹€æ…‹é¡è‰² */
    .seat-occupied { background-color: #e5e7eb; color: #4b5563; border: 1px solid #9ca3af; cursor: not-allowed; }
    .seat-selected { background-color: #2563eb; color: white; border: 1px solid #1d4ed8; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.4); }
    
    .seat-status-0 { background-color: #b7e1cd; color: #0f5132; border: 1px solid #34d399; } 
    .seat-status-1 { background-color: #fce8b2; color: #b45309; border: 1px solid #fcd34d; } 
    .seat-status-2 { background-color: #ea9999; color: #7f1d1d; border: 1px solid #fca5a5; } 
    .seat-status-3 { background-color: #e06666; color: #ffffff; border: 1px solid #b91c1c; } 
    .seat-status-4 { background-color: #cc0000; color: #ffffff; border: 1px solid #991b1b; } 
    .seat-status-high { background-color: #660000; color: #ffffff; border: 1px solid #450a0a; } 

    .stage-bar { background: #4b5563; color: #f9fafb; letter-spacing: 0.2em; border-radius: 4px 4px 8px 8px; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center bg-white sm:bg-gray-100 p-0 sm:p-4">

  <!-- 1. ç™»å…¥é é¢ (Login Page) -->
  <div id="loginPage" class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl flex flex-col justify-center min-h-[60vh] mt-10">
    <h1 class="text-3xl font-bold text-center mb-2 text-gray-800">å­¸ç”Ÿç™»å…¥</h1>
    <p class="text-center text-gray-500 text-sm mb-8">è«‹é©—è­‰èº«åˆ†ä»¥é€²è¡Œé¸ä½</p>
    
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-1">åº§è™Ÿ</label>
        <input type="number" id="loginSeatInput" class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-lg" placeholder="ä¾‹: 12">
      </div>
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-1">èº«åˆ†è­‰å­—è™Ÿ (æˆ–å¯†ç¢¼)</label>
        <input type="text" id="loginPassInput" class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-lg" placeholder="è¼¸å…¥ F æ¬„çš„è³‡æ–™">
      </div>
      <button id="loginButton" class="w-full py-3 mt-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all shadow-lg">ç™»å…¥ç³»çµ±</button>
    </div>
    <div id="loginMessage" class="mt-4 text-center text-red-500 text-sm font-bold"></div>
  </div>

  <!-- 2. é¸ä½ä¸»é é¢ (Main App) - é è¨­éš±è— -->
  <div id="mainApp" class="hidden w-full max-w-xl bg-white p-4 sm:p-8 sm:rounded-2xl sm:shadow-xl flex flex-col min-h-screen sm:min-h-0">
    <div class="mb-4 text-center mt-2 flex justify-between items-center px-2">
      <div>
        <h1 class="text-2xl font-bold text-gray-900 tracking-tight">åº§ä½å³æ™‚é¸ä½</h1>
        <p class="text-gray-500 text-xs mt-1 text-left">ä½ å¥½ï¼Œ<span id="userNameDisplay" class="font-bold text-blue-600"></span> (åº§è™Ÿ:<span id="userSeatDisplay"></span>)</p>
      </div>
      <button onclick="logout()" class="text-xs text-gray-400 underline">ç™»å‡º</button>
    </div>

    <div id="loadingMessage" class="text-center text-blue-600 font-semibold py-20 animate-pulse text-sm flex-grow">æ­£åœ¨è¼‰å…¥åº§ä½è¡¨...</div>
    <div id="errorMessage" class="hidden text-center text-red-600 font-semibold mb-4 bg-red-50 p-3 rounded-lg text-sm"></div>

    <!-- é¸ä½æ“ä½œå€ (å·²ç™»å…¥ï¼Œæ‰€ä»¥ä¸ç”¨è¼¸å…¥åº§è™Ÿ) -->
    <div id="seatForm" class="space-y-3 sm:space-y-6 hidden mb-4">
      <div class="flex flex-col items-center gap-2">
        <label class="text-xs font-bold text-gray-700">æ‚¨é¸æ“‡çš„åº§ä½</label>
        <input type="text" id="selectedSeatInput" placeholder="è«‹é»é¸ä¸‹æ–¹åº§ä½" class="block w-full max-w-[200px] px-4 py-2 bg-blue-50 border-2 border-blue-100 rounded-lg text-center text-xl font-bold text-blue-700" readonly>
      </div>

      <button id="submitButton" class="w-full py-3.5 sm:py-3 px-4 border border-transparent rounded-xl shadow-sm text-lg font-bold text-white bg-gray-400 hover:bg-gray-500 focus:outline-none transition-all transform active:scale-98" disabled>
        ç¢ºèªé€å‡º
      </button>

      <div id="statusMessage" class="hidden p-2 rounded-lg text-xs font-bold text-center transition-all"></div>
    </div>

    <div id="seatMapContainer" class="flex flex-col gap-1.5 sm:gap-3 items-center w-full pb-10 flex-grow justify-center"></div>
  </div>

<script>
  // å…¨åŸŸè®Šæ•¸
  let currentUser = null; // {seatNo, name}
  let seatData = {};
  let currentSelectedSeat = null;

  // DOM å…ƒç´ 
  const loginPage = document.getElementById('loginPage');
  const mainApp = document.getElementById('mainApp');
  const loginButton = document.getElementById('loginButton');
  const loginMessage = document.getElementById('loginMessage');
  
  const selectedSeatInput = document.getElementById('selectedSeatInput');
  const submitButton = document.getElementById('submitButton');
  const loadingMessage = document.getElementById('loadingMessage');
  const seatMapContainer = document.getElementById('seatMapContainer');
  const statusMessage = document.getElementById('statusMessage');

  // --- ç™»å…¥é‚è¼¯ ---
  loginButton.addEventListener('click', () => {
    const seat = document.getElementById('loginSeatInput').value;
    const pass = document.getElementById('loginPassInput').value;
    
    if(!seat || !pass) {
      loginMessage.textContent = "è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š";
      return;
    }
    
    loginButton.disabled = true;
    loginButton.textContent = "é©—è­‰ä¸­...";
    
    google.script.run
      .withSuccessHandler((res) => {
        if(res.success) {
          // ç™»å…¥æˆåŠŸ
          currentUser = res.student;
          showMainApp();
        } else {
          loginMessage.textContent = res.message;
          loginButton.disabled = false;
          loginButton.textContent = "ç™»å…¥ç³»çµ±";
        }
      })
      .withFailureHandler((err) => {
        loginMessage.textContent = "é€£ç·šéŒ¯èª¤: " + err.message;
        loginButton.disabled = false;
        loginButton.textContent = "ç™»å…¥ç³»çµ±";
      })
      .loginStudent(seat, pass);
  });

  function showMainApp() {
    loginPage.classList.add('hidden');
    mainApp.classList.remove('hidden');
    
    // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
    document.getElementById('userNameDisplay').textContent = currentUser.name;
    document.getElementById('userSeatDisplay').textContent = currentUser.seatNo;
    
    // é–‹å§‹è¼‰å…¥åº§ä½è¡¨
    loadData();
  }

  function logout() {
    currentUser = null;
    location.reload(); // é‡æ–°æ•´ç†é é¢ä»¥ç™»å‡º
  }

  // --- é¸ä½ç³»çµ±é‚è¼¯ ---

  function showStatus(message, isSuccess) {
    statusMessage.textContent = message;
    statusMessage.classList.remove('hidden', 'bg-red-50', 'text-red-600', 'bg-green-50', 'text-green-600');
    if (isSuccess) statusMessage.classList.add('bg-green-50', 'text-green-600');
    else statusMessage.classList.add('bg-red-50', 'text-red-600');
  }

    // --- è¿½è¹¤æœ¬è¼ªæŠ½ç±¤çµæœ ---
  let resultPollingTimer = null;

  function startResultPolling() {
    if (resultPollingTimer) clearInterval(resultPollingTimer);
    // æ¯ 4 ç§’å•ä¸€æ¬¡çµæœ
    resultPollingTimer = setInterval(checkMyResult, 4000);
  }

  function stopResultPolling() {
    if (resultPollingTimer) {
      clearInterval(resultPollingTimer);
      resultPollingTimer = null;
    }
  }

  function checkMyResult() {
    if (!currentUser) return;

    google.script.run
      .withSuccessHandler((res) => {
        if (!res || !res.status) return;

        if (res.status === 'PENDING') {
          showStatus('â³ å·²é€å‡ºé¸ä½æ„é¡˜ï¼Œç­‰å¾…è€å¸«åˆ†é…...', true);
        } else if (res.status === 'SUCCESS') {
          stopResultPolling();
          const seatText = res.seat ? `ï¼ˆåº§ä½ï¼š${res.seat}ï¼‰` : '';
          showStatus(`ğŸ‰ æœ¬è¼ªé¸ä½æˆåŠŸï¼${seatText}`, true);
        } else if (res.status === 'FAIL') {
          stopResultPolling();
          showStatus('ğŸ˜¢ æœ¬è¼ªæœªé¸ä¸Šåº§ä½ï¼Œè«‹ç­‰å¾…ä¸‹ä¸€è¼ªã€‚', false);
        } else {
          // NONEï¼šé‚„æ²’é€å‡ºæˆ–è€å¸«é‚„æ²’è·‘é€™è¼ª
        }
      })
      .withFailureHandler((err) => {
        console.log('checkMyResult error:', err);
      })
      .getMyRoundResult(currentUser.seatNo);
  }








  function renderSeatMap() {
    seatMapContainer.innerHTML = '';
    
    // è¬›å°
    const stageWrapper = document.createElement('div');
    stageWrapper.className = 'w-full flex justify-center mb-1 sm:mb-4 px-2'; 
    const stage = document.createElement('div');
    stage.className = 'stage-bar w-full sm:w-3/4 py-1.5 text-center text-xs font-bold shadow-sm';
    stage.textContent = 'è¬›å° (å‰æ–¹)';
    stageWrapper.appendChild(stage);
    seatMapContainer.appendChild(stageWrapper);
    
    // åº§ä½æ’åˆ— A1åœ¨å³ (6->1)
    const seatRows = [
      ['A6', 'A5', 'A4', 'A3', 'A2', 'A1'], 
      ['B6', 'B5', 'B4', 'B3', 'B2', 'B1'], 
      ['C6', 'C5', 'C4', 'C3', 'C2', 'C1'], 
      ['D6', 'D5', 'D4', 'D3', 'D2', 'D1'], 
      ['E6', 'E5', 'E4', 'E3', 'E2', 'E1'], 
      ['F5', 'F4', 'F3', 'F2', 'F1']        
    ];

    seatRows.forEach(row => {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'flex justify-center gap-1.5 sm:gap-2 w-full px-1';
      
      row.forEach(seatName => {
        const button = document.createElement('button');
        button.className = 'seat-button'; 
        const data = seatData[seatName] || { isOccupied: false, isAvailable: true, rawStatus: 0 };
        
        let statusText = '', className = 'seat-available';

        if (data.isOccupied) {
          className = 'seat-occupied';
          statusText = `${data.occupantSeatId}`;
          button.disabled = true;
        } else if (!data.isAvailable) {
          className = 'seat-occupied';
          statusText = 'X';
          button.disabled = true;
        } else {
          const count = typeof data.rawStatus === 'number' ? data.rawStatus : 0;
          if (count === 0) { className = 'seat-status-0'; statusText = 'å¯é¸'; }
          else if (count === 1) { className = 'seat-status-1'; statusText = `${count}äºº`; }
          else if (count === 2) { className = 'seat-status-2'; statusText = `${count}äºº`; }
          else if (count === 3) { className = 'seat-status-3'; statusText = `${count}äºº`; }
          else if (count === 4) { className = 'seat-status-4'; statusText = `${count}äºº`; }
          else { className = 'seat-status-high'; statusText = `${count}äºº`; }
          
          button.onclick = (e) => { e.preventDefault(); selectSeat(seatName, button); };
        }

        button.innerHTML = `<span class="text-sm font-extrabold leading-none mb-0.5">${seatName}</span><span class="text-[10px] font-medium opacity-90 leading-none">${statusText}</span>`;
        button.classList.add(className);
        if (currentSelectedSeat === seatName) {
          button.classList.remove(className); button.classList.add('seat-selected');
        }
        rowDiv.appendChild(button);
      });
      seatMapContainer.appendChild(rowDiv);
    });
    
    document.getElementById('seatForm').classList.remove('hidden');
    loadingMessage.classList.add('hidden');
  }


 





  function selectSeat(seatName, button) {
    currentSelectedSeat = seatName;
    selectedSeatInput.value = seatName;
    renderSeatMap();
    
    // å•Ÿç”¨æŒ‰éˆ•
    submitButton.disabled = false;
    submitButton.classList.remove('bg-gray-400', 'hover:bg-gray-500');
    submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700', 'shadow-lg');
    submitButton.textContent = 'ç¢ºèªæäº¤';
  }

  function submitChoice() {
    if (!currentUser || !currentSelectedSeat) return;

    submitButton.disabled = true;
    submitButton.textContent = 'æäº¤ä¸­...';
    
    google.script.run
      .withSuccessHandler(handleSubmissionSuccess)
      .withFailureHandler(handleSubmissionFailure)
      .recordChoice({ seatId: currentUser.seatNo, choice: currentSelectedSeat }); // ä½¿ç”¨ç™»å…¥è€…çš„åº§è™Ÿ
  }

    function handleSubmissionSuccess(response) {
    if (response.success) {
      showStatus(`âœ… æˆåŠŸé€å‡ºé¸ä½æ„é¡˜ï¼(åº§è™Ÿ ${response.seatId}ï¼Œé¸æ“‡ ${response.choice})`, true);
      loadData();
      currentSelectedSeat = null; 
      selectedSeatInput.value = ''; 
      submitButton.disabled = true;
      submitButton.classList.add('bg-gray-400', 'hover:bg-gray-500');
      submitButton.textContent = 'æäº¤é¸ä½æ„é¡˜';

      // ğŸ†• é–‹å§‹è¼ªè©¢æœ¬è¼ªæŠ½ç±¤çµæœ
      startResultPolling();

    } else {
      showStatus(`âŒ æäº¤å¤±æ•—: ${response.message}`, false);
      submitButton.disabled = false;
    }
  }


  function handleSubmissionFailure(error) {
    showStatus(`âŒ ç³»çµ±éŒ¯èª¤ï¼š${error.message}`, false);
    submitButton.disabled = false;
  }

  function loadData() {
    // è¼ªè©¢ï¼šèƒŒæ™¯æ›´æ–°
    google.script.run
      .withSuccessHandler(handleDataSuccess)
      .withFailureHandler((e) => console.log(e))
      .getSeatMapData();
  }

  function handleDataSuccess(data) {
    if (data && data.seatMap) {
      seatData = data.seatMap;
      renderSeatMap();
      
      // æ¯ 5 ç§’è¼ªè©¢
      if (window.pollingTimer) clearTimeout(window.pollingTimer);
      window.pollingTimer = setTimeout(loadData, 5000); 
    }
  }

  submitButton.addEventListener('click', submitChoice);

</script>
</body>
</html>