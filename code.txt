// =================================================================
//                        å…¨åŸŸè¨­å®šèˆ‡å¸¸æ•¸
// =================================================================
const FORM_RESPONSES_SHEET_NAME = 'è¡¨å–®å›æ‡‰ 1'; 
const STUDENTS_SHEET_NAME = 'Students';
const SEAT_VIEW_SHEET_NAME = 'Seat_View';
const CHOICES_SHEET_NAME = 'Round_now_Choices';
const LOTTERY_RESULT_SHEET_NAME = 'Lottery_Result';

// =================================================================
//                        Web App ä»‹é¢å‡½å¼
// =================================================================

/**
 * Web App å…¥å£é»
 */
function doGet() {
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setTitle('åº§ä½å³æ™‚é¸ä½ç³»çµ±')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

/**
 * ğŸ†• æ–°å¢å‡½å¼ï¼šå­¸ç”Ÿç™»å…¥é©—è­‰
 * @param {string} seatNo - åº§è™Ÿ
 * @param {string} password - èº«åˆ†è­‰å­—è™Ÿ (æˆ–å¯†ç¢¼)
 */
function loginStudent(seatNo, password) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const studentSheet = ss.getSheetByName(STUDENTS_SHEET_NAME);
    
    if (!studentSheet) throw new Error('æ‰¾ä¸åˆ°å­¸ç”Ÿåå–®');

    // è®€å– Aæ¬„(åº§è™Ÿ), Bæ¬„(å§“å), Fæ¬„(èº«åˆ†è­‰/å¯†ç¢¼)
    // ç¯„åœ A2:F
    const lastRow = studentSheet.getLastRow();
    const data = studentSheet.getRange('A2:F' + lastRow).getValues();
    
    // æœå°‹åŒ¹é…çš„å­¸ç”Ÿ
    let foundStudent = null;
    
    for (let i = 0; i < data.length; i++) {
      const rowSeat = String(data[i][0]).trim(); // Aæ¬„
      const rowName = data[i][1];                // Bæ¬„
      const rowPass = String(data[i][5]).trim(); // Fæ¬„ (ç´¢å¼• 5)

      // æ¯”å°åº§è™Ÿèˆ‡å¯†ç¢¼ (ä¸åˆ†å¤§å°å¯«)
      if (rowSeat === String(seatNo).trim() && rowPass.toUpperCase() === String(password).trim().toUpperCase()) {
        foundStudent = {
          seatNo: rowSeat,
          name: rowName
        };
        break;
      }
    }

    if (foundStudent) {
      return { success: true, student: foundStudent };
    } else {
      return { success: false, message: 'åº§è™Ÿæˆ–èº«åˆ†è­‰å­—è™ŸéŒ¯èª¤' };
    }

  } catch (e) {
    Logger.log("Login Error: " + e.message);
    return { success: false, message: 'ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦' };
  }
}

/**
 * å‡½æ•¸ 1: è®€å–åº§ä½åœ–æ•¸æ“š
 */
function getSeatMapData() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const seatViewSheet = ss.getSheetByName(SEAT_VIEW_SHEET_NAME);
    
    if (!seatViewSheet) throw new Error(`æ‰¾ä¸åˆ°å·¥ä½œè¡¨: ${SEAT_VIEW_SHEET_NAME}`);

    const range = seatViewSheet.getRange('B4:L20'); 
    const rawData = range.getValues(); 
    
    const seatMap = {};

    for (let i = 0; i < rawData.length; i += 3) {
      if (i + 1 >= rawData.length) continue; 

      const rowName = rawData[i];     
      const rowStatus = rawData[i + 1]; 
      
      for (let j = 0; j < rowName.length; j++) {
        const seatId = String(rowName[j]).trim();
        const status = rowStatus[j]; 

        if (seatId !== '' && seatId.toUpperCase() !== 'FALSE' && !seatId.includes('å­¸å¹´')) {
          let isOccupied = false;
          let occupantSeatId = null;
          let isAvailable = true;

          if (typeof status === 'number') {
            isOccupied = false;
            isAvailable = true; 
          } else if (String(status).length > 0) {
            isOccupied = true;
            isAvailable = false;
            occupantSeatId = String(status);
          }

          seatMap[seatId] = {
            isOccupied: isOccupied,
            isAvailable: isAvailable,
            occupantSeatId: occupantSeatId,
            rawStatus: status
          };
        }
      }
    }
    return { seatMap: seatMap };
  } catch (e) {
    return { error: e.message };
  }
}

/**
 * å‡½æ•¸ 2: è™•ç†å‰ç«¯æäº¤
 */
function recordChoice(formData) {
  const { seatId, choice } = formData;
  
  if (!seatId || !choice) return { success: false, message: 'è³‡æ–™ä¸å®Œæ•´' };

  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const responseSheet = ss.getSheetByName(FORM_RESPONSES_SHEET_NAME); 
    const stuSheet = ss.getSheetByName(STUDENTS_SHEET_NAME);
    
    if (!responseSheet) return { success: false, message: 'æ‰¾ä¸åˆ°è¡¨å–®å›æ‡‰å·¥ä½œè¡¨' };
    
    const rowData = [
      new Date(), 
      seatId,     
      choice,     
      choice      
    ];
    responseSheet.appendRow(rowData);

    // ğŸ†• æ¸…æ‰é€™ä½åŒå­¸ä¸Šä¸€è¼ªçš„çµæœï¼ˆStudents!Gï¼‰
    if (stuSheet) {
      const lastRow = stuSheet.getLastRow();
      if (lastRow >= 2) {
        const range = stuSheet.getRange('A2:G' + lastRow);
        const data = range.getValues();
        const targetSeat = String(seatId).trim();
        let changed = false;

        for (let i = 0; i < data.length; i++) {
          const sNo = String(data[i][0]).trim();
          if (sNo === targetSeat) {
            data[i][6] = '';   // G æ¬„æ¸…ç©º
            changed = true;
            break;
          }
        }
        if (changed) range.setValues(data);
      }
    }

    return { success: true, seatId: seatId, choice: choice };
  } catch (e) {
    return { success: false, message: `å¾Œç«¯éŒ¯èª¤ï¼š${e.message}` };
  }
}

// =================================================================
//                 ç©åˆ†åˆ†é…æ ¸å¿ƒé‚è¼¯
// =================================================================

function getStudentScores() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(STUDENTS_SHEET_NAME);
  const data = sheet.getRange('A2:E' + sheet.getLastRow()).getValues();
  const map = {};
  data.forEach(row => {
    const seatNo = Number(row[0]);
    const score = Number(row[4]); 
    if (seatNo) map[seatNo] = (typeof score === 'number') ? score : 0;
  });
  return map;
}

function determineWinner(contenders) {
  // 1. å…ˆæŠŠæ¯å€‹äººçš„ã€Œæ¬Šé‡ã€æŠ“å‡ºä¾†ï¼ˆç”¨ score ç•¶æ¬Šé‡ï¼‰
  let totalWeight = 0;
  const weights = [];

  for (let i = 0; i < contenders.length; i++) {
    const c = contenders[i];
    // ç¢ºä¿æ˜¯æ•¸å­—ï¼Œä¸”ä¸è¦å°æ–¼ 0
    let w = Number(c.score);
    if (isNaN(w) || w < 0) w = 0;
    weights.push(w);
    totalWeight += w;
  }

  // 2. å¦‚æœå…¨éƒ¨äººæ¬Šé‡éƒ½ 0ï¼ˆä¾‹å¦‚éƒ½æ²’åˆ†æ•¸ï¼‰ï¼Œå°±æ”¹æˆã€Œæ©Ÿæœƒå‡ç­‰éš¨æ©Ÿã€
  if (totalWeight <= 0) {
    const randomIndex = Math.floor(Math.random() * contenders.length);
    return contenders[randomIndex].seatNo;
  }

  // 3. åšä¸€å€‹ 0 ~ totalWeight çš„éš¨æ©Ÿæ•¸ï¼Œä¾åºæ‰£æ‰æ¯å€‹äººçš„æ¬Šé‡
  //    æ‰åˆ°å“ªå€‹å€é–“å°±æ˜¯èª°ä¸­çï¼ˆå…¸å‹ weighted random æ³•ï¼‰
  let r = Math.random() * totalWeight;

  for (let i = 0; i < contenders.length; i++) {
    r -= weights[i];
    if (r <= 0) {
      return contenders[i].seatNo;  // é€™å€‹äººä¸­
    }
  }

  // ç†è«–ä¸Šä¸æœƒåˆ°é€™è£¡ï¼Œä½†ä¿éšªèµ·è¦‹
  return contenders[contenders.length - 1].seatNo;
}

function updateStudentsFinalSeat(winnerMap) {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(STUDENTS_SHEET_NAME);
    const dataRange = sheet.getRange('A2:D' + sheet.getLastRow());
    const data = dataRange.getValues();
    
    for (let i = 0; i < data.length; i++) {
        const seatNo = Number(data[i][0]);
        if (winnerMap[seatNo]) {
            sheet.getRange(2 + i, 4).setValue(winnerMap[seatNo]); 
        }
    }
}

function allocateSeatsByScore() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const choicesSheet = ss.getSheetByName(CHOICES_SHEET_NAME); 
  const lotteryResultSheet = ss.getSheetByName(LOTTERY_RESULT_SHEET_NAME);

  const scoreMap = getStudentScores();

  // â‘  è®€å–æœ¬è¼ªé¸ä½è³‡æ–™
  const lastRow = choicesSheet.getLastRow();
  if (lastRow <= 1) {
     ss.toast('æœ¬è¼ªå°šç„¡é¸ä½è³‡æ–™');
     return { success: true };
  }

  const choiceData = choicesSheet.getRange('A2:C' + lastRow).getValues();

  // â‘¡ æ‰¾å‡ºæœ‰åƒåŠ çš„äºº
  const participants = new Set();
  choiceData.forEach(row => {
    const seatNo = Number(row[0]);
    if (seatNo) participants.add(seatNo);
  });

  const stuSheet = ss.getSheetByName(STUDENTS_SHEET_NAME);
  if (!stuSheet) {
    ss.toast('æ‰¾ä¸åˆ°å­¸ç”Ÿåå–®å·¥ä½œè¡¨');
    return { success: false, message: 'æ‰¾ä¸åˆ°å­¸ç”Ÿåå–®å·¥ä½œè¡¨' };
  }

  const stuLastRow = stuSheet.getLastRow();
  let stuData = [];
  let seatRowIndex = {};  // åº§è™Ÿ â†’ åœ¨ stuData çš„ index

  if (stuLastRow >= 2) {
    // ğŸ†• é€™è£¡æ”¹æˆ A2:Gï¼Œä¸€ä½µæŠŠ G æ¬„è®€é€²ä¾†
    const stuRange = stuSheet.getRange('A2:G' + stuLastRow);
    stuData = stuRange.getValues();

    for (let i = 0; i < stuData.length; i++) {
      const sNo = Number(stuData[i][0]); // A æ¬„ï¼šåº§è™Ÿ
      if (sNo) {
        seatRowIndex[sNo] = i;
      }
      // å¦‚æœæœ‰åƒåŠ æœ¬è¼ª â†’ å…ˆæ¸…æ‰åŸæœ¬çš„æœ€çµ‚åº§ä½ï¼ˆDï¼‰èˆ‡çµæœï¼ˆGï¼‰
      if (participants.has(sNo)) {
        stuData[i][3] = '';        // D æ¬„ï¼šæœ€çµ‚åº§ä½
        stuData[i][6] = 'PENDING'; // G æ¬„ï¼šå…ˆæ¨™è¨˜ç­‰å¾…åˆ†é…
      }
    }

    // å…ˆä¸è¦ setValuesï¼Œç­‰çµæœå…¨éƒ¨ç®—å®Œå†ä¸€æ¬¡å¯«å›å»
  }

  // â‘¢ å»ºç«‹ choiceMapï¼šæ¯å€‹åº§ä½ â†’ åƒåŠ ç«¶çˆ­çš„å­¸ç”Ÿåˆ—è¡¨
  const choiceMap = {};
  choiceData.forEach(row => {
    const seatNo = Number(row[0]);
    const seatId = String(row[2]).trim().toUpperCase(); 
    const score = scoreMap[seatNo] !== undefined ? scoreMap[seatNo] : 0; 

    if (!seatNo || !seatId) return;

    if (!choiceMap[seatId]) choiceMap[seatId] = [];
    choiceMap[seatId].push({ seatNo, score });
  });
  
  let allocations = 0;
  const winnerMap = {}; 
  const winners = []; 
  
  // â‘£ å°æ¯å€‹åº§ä½åšåŠ æ¬ŠæŠ½ç±¤
  for (const seatId in choiceMap) {
    const contenders = choiceMap[seatId];
    if (contenders.length > 0) {
      const winnerSeatNo = determineWinner(contenders);
      
      allocations++;
      winnerMap[winnerSeatNo] = seatId;
      
      const method = (contenders.length > 1) ? 'ç«¶çˆ­å‹å‡º' : 'ç›´æ¥åˆ†é…';
      winners.push([winnerSeatNo, seatId, method, new Date()]);
    }
  }

  // ğŸ†• â‘£-2 åœ¨ stuData å…§å¯«å…¥ SUCCESS / FAIL
  participants.forEach(seatNo => {
    const idx = seatRowIndex[seatNo];
    if (idx === undefined) return;
    if (winnerMap[seatNo]) {
      stuData[idx][3] = winnerMap[seatNo]; // Dï¼šæœ€çµ‚åº§ä½
      stuData[idx][6] = 'SUCCESS';         // Gï¼šæœ¬è¼ªæˆåŠŸ
    } else {
      // æ²’ä¸­ç±¤
      stuData[idx][6] = 'FAIL';
    }
  });

  // æŠŠ Students å…¨éƒ¨æ›´æ–°å›å»
  if (stuLastRow >= 2) {
    const stuRange = stuSheet.getRange('A2:G' + stuLastRow);
    stuRange.setValues(stuData);
  }

  // åŸæœ¬è¨˜éŒ„æŠ½ç±¤çµæœçš„ç¨‹å¼ç…§ç”¨
  if (lotteryResultSheet && winners.length > 0) {
     const nextRow = lotteryResultSheet.getLastRow() + 1;
     lotteryResultSheet.getRange(nextRow, 1, winners.length, 4).setValues(winners);
  }

  ss.toast(`âœ… åˆ†é…å®Œæˆï¼š${allocations} äººç²é¸ã€‚`);
  return { success: true };
}

// =================================================================
//                 ç®¡ç†èˆ‡é‡ç½®æµç¨‹
// =================================================================

function initNextRound() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const formSheet = ss.getSheetByName(FORM_RESPONSES_SHEET_NAME);
  if (formSheet && formSheet.getLastRow() > 1) {
    formSheet.getRange(2, 1, formSheet.getLastRow() - 1, formSheet.getLastColumn()).clearContent();
  }
  ss.toast('âœ… å·²åˆå§‹åŒ–ä¸‹ä¸€è¼ª');
}

function finishRoundAndInitNext() {
  SpreadsheetApp.getActiveSpreadsheet().toast('ğŸ”„ åŸ·è¡Œåˆ†é…ä¸­...');
  try {
    allocateSeatsByScore(); 
    initNextRound();        
  } catch (e) {
    Browser.msgBox('éŒ¯èª¤', e.message, Browser.Buttons.OK);
  }
}

function resetSeatMission() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const stuSheet = ss.getSheetByName(STUDENTS_SHEET_NAME);
  const formSheet = ss.getSheetByName(FORM_RESPONSES_SHEET_NAME);
  const lotterySheet = ss.getSheetByName(LOTTERY_RESULT_SHEET_NAME);

  if (stuSheet) stuSheet.getRange('D2:D').clearContent();
  if (formSheet && formSheet.getLastRow() > 1) formSheet.getRange(2, 1, formSheet.getLastRow()-1, formSheet.getLastColumn()).clearContent();
  if (lotterySheet && lotterySheet.getLastRow() > 1) lotterySheet.getRange(2, 1, lotterySheet.getLastRow()-1, lotterySheet.getLastColumn()).clearContent();

  ss.toast('âœ… ç³»çµ±å·²é‡ç½®');
}

function randomSimulateChoices() {
  const ss = SpreadsheetApp.getActive();
  const formSheet = ss.getSheetByName(FORM_RESPONSES_SHEET_NAME);
  const stuSheet = ss.getSheetByName(STUDENTS_SHEET_NAME);

  if (!formSheet || !stuSheet) {
    ss.toast('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å¿…è¦çš„å·¥ä½œè¡¨');
    Logger.log('âŒ æ‰¾ä¸åˆ°å·¥ä½œè¡¨');
    return;
  }

  const lastRow = stuSheet.getLastRow();
  if (lastRow < 2) {
    ss.toast('éŒ¯èª¤ï¼šå­¸ç”Ÿåå–®ç‚ºç©º');
    Logger.log('âŒ å­¸ç”Ÿåå–®ç‚ºç©º');
    return;
  }

  // 1. æŠ“ Aã€D æ¬„ï¼šåº§è™Ÿ + æœ€çµ‚åº§ä½
  const dataRange = stuSheet.getRange(2, 1, lastRow - 1, 4); // A:D
  const data = dataRange.getValues();

  // æ‰€æœ‰åˆæ³•åº§ä½ï¼ˆä¾ä½ çš„å¯¦éš›æ•™å®¤æ”¹ï¼‰
  const allValidSeats = [
    'A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2',
    'A3','A4','A5','A6','B3','B4','B5','B6',
    'C3','C4','C5','C6','D3','D4','D5','D6',
    'E3','E4','E5','E6','F3','F4','F5'
  ];

  const takenSeats = new Set();   // D æ¬„å·²ç¶“æœ‰äººå
  const unassignedStudents = [];  // D æ¬„ç©ºç™½çš„å­¸ç”Ÿåº§è™Ÿ

  data.forEach(row => {
    const seatNo = String(row[0]).trim();                // A æ¬„ï¼šåº§è™Ÿ
    const finalSeat = String(row[3]).trim().toUpperCase(); // D æ¬„ï¼šæœ€çµ‚åº§ä½

    if (!seatNo) return;

    if (finalSeat && finalSeat !== 'UNDEFINED') {
      takenSeats.add(finalSeat);
    } else {
      unassignedStudents.push(seatNo);
    }
  });

  Logger.log('ğŸ‘¨â€ğŸ“ æœªæ’ä½å­¸ç”Ÿï¼š%s äºº â†’ %s',
             unassignedStudents.length,
             unassignedStudents.join(', '));
  Logger.log('ğŸš« å·²ä½”ç”¨åº§ä½ï¼š%s â†’ %s',
             takenSeats.size,
             Array.from(takenSeats).join(', '));

  // 2. å‰©é¤˜ã€Œå¯é¸åº§ä½æ± ã€= é‚„æ²’åˆ†çµ¦ä»»ä½•äººçš„
  const availableSeats = allValidSeats.filter(seat => !takenSeats.has(seat));
  Logger.log('ğŸ’º å‰©é¤˜å¯é¸åº§ä½ (%s)ï¼š%s',
             availableSeats.length,
             availableSeats.join(', '));

  if (unassignedStudents.length === 0) {
    ss.toast('æ‰€æœ‰å­¸ç”Ÿéƒ½å·²ç¶“æœ‰åº§ä½');
    return;
  }
  if (availableSeats.length === 0) {
    ss.toast('å·²ç„¡å‰©é¤˜ç©ºä½å¯ä»¥æŠ½ï¼ˆé€£é‡è¤‡æŠ½éƒ½æ²’æ±è¥¿å¯æŠ½ï¼‰');
    return;
  }

  // 3. å¹«æ‰€æœ‰é‚„æ²’åº§ä½çš„å­¸ç”Ÿã€Œå„æŠ½ä¸€æ¬¡ã€
  const newRows = [];

  // æ‰“äº‚å­¸ç”Ÿé †åºï¼ˆå¯æœ‰å¯ç„¡ï¼Œç´”éš¨æ©Ÿæ„Ÿï¼‰
  const shuffledStudents = [...unassignedStudents].sort(() => Math.random() - 0.5);

  shuffledStudents.forEach((seatNo, idx) => {
    const randomSeatIndex = Math.floor(Math.random() * availableSeats.length);
    const choice = availableSeats[randomSeatIndex];   // âœ… å¾ç©ºä½æ± ä¸­æŠ½ï¼Œä½†ä¸åˆªæ‰ â†’ å…è¨±é‡è¤‡

    Logger.log('âœ… æ¨¡æ“¬ç¬¬ %s ç­†ï¼šåº§è™Ÿ %s æŠ½åˆ° %s', idx + 1, seatNo, choice);

    newRows.push([new Date(), seatNo, choice]);
    // âŒ ä¸å† spliceï¼Œåº§ä½ç•™åœ¨æ± å­è£¡
  });

  // 4. å¯«å›ã€Œè¡¨å–®å›æ‡‰ã€
  if (newRows.length > 0) {
    const startRow = formSheet.getLastRow() + 1;
    formSheet.getRange(startRow, 1, newRows.length, 3).setValues(newRows);
    ss.toast(`å·²ç‚º ${newRows.length} ä½æœªæ’ä½åŒå­¸ï¼Œå„æ¨¡æ“¬æŠ½äº†ä¸€å€‹å€™é¸åº§ä½ï¼ˆå¯é‡è¤‡ï¼‰`);
    Logger.log('ğŸ“¥ å¯«å…¥è¡¨å–®å›æ‡‰ %s ç­†ï¼ˆèµ·å§‹åˆ— %sï¼‰', newRows.length, startRow);
  } else {
    ss.toast('æ²’æœ‰ç”¢ç”Ÿä»»ä½•æ¨¡æ“¬è³‡æ–™');
    Logger.log('â„¹ æ²’æœ‰ç”¢ç”Ÿä»»ä½•æ¨¡æ“¬è³‡æ–™');
  }
}

function getMyRoundResult(seatNo) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const stuSheet = ss.getSheetByName(STUDENTS_SHEET_NAME);
  if (!stuSheet) return { status: 'NONE' };

  const lastRow = stuSheet.getLastRow();
  if (lastRow < 2) return { status: 'NONE' };

  const data = stuSheet.getRange('A2:G' + lastRow).getValues();
  const target = String(seatNo).trim();

  for (let i = 0; i < data.length; i++) {
    const sNo = String(data[i][0]).trim();
    if (sNo === target) {
      const result = String(data[i][6] || '').toUpperCase(); // Gæ¬„
      const finalSeat = data[i][3] || ''; // Dæ¬„ï¼šæœ€çµ‚åº§ä½

      if (result === 'SUCCESS') return { status: 'SUCCESS', seat: finalSeat };
      if (result === 'FAIL')    return { status: 'FAIL' };
      if (result === 'PENDING') return { status: 'PENDING' };
      return { status: 'NONE' };
    }
  }
  return { status: 'NONE' };
}
