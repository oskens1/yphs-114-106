<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è€å¸«ç®¡ç†å¾Œå° - åº§ä½é¸ä½ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- QR Code Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
    .seat-box {
      width: 70px; height: 70px; display: flex; flex-direction: column;
      justify-content: center; align-items: center; border-radius: 8px;
      border: 1px solid #cbd5e1; background: white; font-size: 12px;
    }
    .occupied { background-color: #fce8b2; border-color: #fcd34d; } 
    .available { background-color: #b7e1cd; border-color: #34d399; } 
    .conflict { background-color: #ea9999 !important; border-color: #fca5a5 !important; color: #7f1d1d !important; } 
    .status-badge { font-size: 10px; padding: 1px 4px; border-radius: 4px; margin-top: 2px; }
  </style>
</head>
<body class="p-4">

  <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-6">
    
    <!-- å·¦å´ï¼šåº§ä½æŠ•å½±å€ -->
    <div class="flex-grow bg-white p-6 rounded-2xl shadow-lg">
      <div class="text-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">106 ç­ç´šåº§ä½è¡¨ (å³æ™‚å‹•æ…‹)</h1>
        <div class="bg-gray-800 text-white py-2 px-10 rounded-lg inline-block mt-4 font-bold">è¬›å° (å‰æ–¹)</div>
      </div>

      <div id="seatMap" class="flex flex-col gap-4 items-center overflow-auto">
        <!-- åº§ä½åœ°åœ–ç”± JS ç”¢ç”Ÿ -->
        <div class="animate-pulse py-20 text-gray-400 text-lg">æ­£åœ¨è®€å–é›²ç«¯åº§ä½è³‡æ–™...</div>
      </div>
    </div>

    <!-- å³å´ï¼šæ§åˆ¶é¢æ¿ -->
    <div class="w-full lg:w-80 flex flex-col gap-6">
      
      <!-- ç‹€æ…‹èˆ‡ QR Code -->
      <div class="bg-white p-6 rounded-2xl shadow-md text-center">
        <h2 class="text-lg font-bold mb-4">å­¸ç”Ÿç«¯å…¥å£</h2>
        <div id="qrcode" class="flex justify-center mb-4"></div>
        <p class="text-xs text-gray-500 break-all mb-2" id="urlText"></p>
        <div id="statusIndicator" class="py-2 px-4 rounded-full text-sm font-bold bg-gray-100 text-gray-400">
          è®€å–ç‹€æ…‹ä¸­...
        </div>
      </div>

      <!-- æ“ä½œæŒ‰éˆ• -->
      <div class="bg-white p-6 rounded-2xl shadow-md flex flex-col gap-3">
        <h2 class="text-lg font-bold mb-2">ç®¡ç†æ“ä½œ</h2>
        
        <div class="flex gap-2">
          <button onclick="toggleSystem(true)" class="flex-1 py-2 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition shadow-md active:scale-95 text-sm">ğŸš€ é–‹æ”¾</button>
          <button onclick="toggleSystem(false)" class="flex-1 py-2 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition shadow-md active:scale-95 text-sm">ğŸ”’ é–å®š</button>
        </div>

        <button onclick="autoFillChoices()" class="w-full py-3 bg-yellow-500 text-white rounded-xl font-bold hover:bg-yellow-600 transition shadow-md active:scale-95">
          ğŸª„ è£œå…¨æœªé¸ä½è€… (éš¨æ©Ÿ)
        </button>

        <button onclick="runLottery()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition shadow-md active:scale-95">
          ğŸ² åŸ·è¡ŒåŠ æ¬ŠæŠ½ç±¤
        </button>

        <hr class="my-2">

        <button onclick="showArchiveModal()" class="w-full py-3 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition shadow-md active:scale-95">
          ğŸ’¾ åƒ…åŸ·è¡Œå­˜æª”
        </button>

        <button onclick="handleReset()" class="w-full py-2 bg-gray-400 text-white rounded-xl font-bold hover:bg-gray-500 transition shadow-md active:scale-95 text-xs">
          ğŸ§¹ åƒ…é‡ç½®ç³»çµ± (æ¸…ç©º)
        </button>
      </div>

      <div class="text-[10px] text-gray-300 text-center">
        æ°¸ä¹…æ€§é¸ä½ç³»çµ± v2.0 | Cline AI æ•´åˆç‰ˆ
      </div>
    </div>
  </div>

  <!-- å­˜æª” Modal -->
  <div id="archiveModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-2xl w-full max-w-sm">
      <h3 class="text-xl font-bold mb-4">å­˜æª”æœ¬è¼ªçµæœ</h3>
      <input type="text" id="roundNameInput" placeholder="è¼¸å…¥è¼ªæ¬¡åç¨± (ä¾‹: é–‹å­¸ç¬¬ä¸€æ¬¡)" class="w-full border p-3 rounded-lg mb-4">
      <div class="flex gap-2">
        <button onclick="closeArchiveModal()" class="flex-1 py-2 bg-gray-200 rounded-lg font-bold">å–æ¶ˆ</button>
        <button onclick="confirmArchive()" class="flex-1 py-2 bg-purple-600 text-white rounded-lg font-bold">ç¢ºèªå­˜æª”</button>
      </div>
    </div>
  </div>

  <script>
    let currentWebAppUrl = '';

    window.onload = () => {
      loadSystemStatus();
      loadSeatMap();
      setInterval(loadSeatMap, 5000); 
    };

    function loadSystemStatus() {
      google.script.run.withSuccessHandler(res => {
        currentWebAppUrl = res.webAppUrl;
        document.getElementById('urlText').innerText = currentWebAppUrl;
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById("qrcode"), { text: currentWebAppUrl, width: 160, height: 160 });
        updateStatusUI(res.isOpen);
      }).getSystemStatus();
    }

    function updateStatusUI(isOpen) {
      const indicator = document.getElementById('statusIndicator');
      if (isOpen) {
        indicator.innerText = "ğŸŸ¢ é¸ä½é–‹æ”¾ä¸­";
        indicator.className = "py-2 px-4 rounded-full text-sm font-bold bg-green-100 text-green-700 animate-pulse";
      } else {
        indicator.innerText = "ğŸ”´ é¸ä½å·²é–å®š";
        indicator.className = "py-2 px-4 rounded-full text-sm font-bold bg-red-100 text-red-700";
      }
    }

    function toggleSystem(isOpen) {
      google.script.run.withSuccessHandler(res => {
        updateStatusUI(res.isOpen);
        alert(res.isOpen ? "å·²é–‹æ”¾å­¸ç”Ÿé¸ä½ï¼" : "å·²é–å®šç³»çµ±ã€‚");
      }).setSystemStatus(isOpen);
    }

    function loadSeatMap() {
      google.script.run.withSuccessHandler(res => {
        if (res.error) return;
        renderMap(res.seatMap);
      }).getSeatMapData();
    }

    function renderMap(seatMap) {
      const container = document.getElementById('seatMap');
      container.innerHTML = '';
      const seatRows = [
        ['A6', 'A5', 'A4', 'A3', 'A2', 'A1'], ['B6', 'B5', 'B4', 'B3', 'B2', 'B1'], 
        ['C6', 'C5', 'C4', 'C3', 'C2', 'C1'], ['D6', 'D5', 'D4', 'D3', 'D2', 'D1'], 
        ['E6', 'E5', 'E4', 'E3', 'E2', 'E1'], ['F5', 'F4', 'F3', 'F2', 'F1']        
      ];
      seatRows.forEach(row => {
        const rowDiv = document.createElement('div');
        rowDiv.className = "flex gap-3 justify-center w-full";
        row.forEach(id => {
          const data = seatMap[id] || { isOccupied: false, rawStatus: 0 };
          const div = document.createElement('div');
          const count = data.rawStatus || 0;
          let bgClass = data.isOccupied ? 'occupied' : 'available';
          if (!data.isOccupied && count >= 2) bgClass = 'conflict'; 
          div.className = `seat-box ${bgClass}`;
          let content = `<span class="font-bold ${count >= 2 && !data.isOccupied ? 'text-red-900' : 'text-gray-400'} text-[10px]">${id}</span>`;
          if (data.isOccupied) {
            content += `<span class="text-lg font-bold text-amber-900">${data.occupantSeatId}</span>`;
            content += `<span class="status-badge bg-amber-200 text-amber-900 font-bold">å·²ä½”ç”¨</span>`;
          } else {
            content += `<span class="text-lg font-bold ${count >= 2 ? 'text-red-900' : 'text-green-800'}">${count} äºº</span>`;
            content += `<span class="status-badge ${count >= 2 ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'} font-bold">ç«¶çˆ­ä¸­</span>`;
          }
          div.innerHTML = content;
          rowDiv.appendChild(div);
        });
        container.appendChild(rowDiv);
      });
    }

    function runLottery() {
      if (!confirm("ç¢ºå®šè¦åŸ·è¡ŒåŠ æ¬ŠæŠ½ç±¤å—ï¼Ÿé€™æœƒæ›´æ–°å­¸ç”Ÿçš„æœ€çµ‚åº§ä½ã€‚")) return;
      google.script.run.withSuccessHandler(res => {
        alert("æŠ½ç±¤å®Œæˆï¼å…±æœ‰ " + res.count + " äººç²é¸åº§ä½ã€‚");
        loadSeatMap();
      }).allocateSeatsByScore();
    }

    function autoFillChoices() {
      if (!confirm("ç¢ºå®šè¦å¹«æ‰€æœ‰å°šæœªé¸ä½çš„åŒå­¸éš¨æ©Ÿå¡«å…¥å¿—é¡˜å—ï¼Ÿ\n(åŒ…å«ä¸Šä¸€è¼ªæœªä¸­ç±¤è€…)")) return;
      google.script.run.withSuccessHandler(res => {
        alert(res.message);
        loadSeatMap();
      }).simulateMissingChoices();
    }

    function showArchiveModal() { document.getElementById('archiveModal').classList.remove('hidden'); }
    function closeArchiveModal() { document.getElementById('archiveModal').classList.add('hidden'); }

    function confirmArchive() {
      const name = document.getElementById('roundNameInput').value;
      if (!name) return alert("è«‹è¼¸å…¥è¼ªæ¬¡åç¨±");
      google.script.run.withSuccessHandler(res => {
        alert(res.message);
        closeArchiveModal();
      }).archiveOnly(name);
    }

    function handleReset() {
      if (!confirm("âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦æ¸…ç©ºç›®å‰æ‰€æœ‰äººçš„åº§ä½èˆ‡ç‹€æ…‹å—ï¼Ÿ\n(è«‹ç¢ºä¿æ‚¨å·²ç¶“åŸ·è¡Œéå­˜æª”)")) return;
      if (!confirm("æœ€å¾Œç¢ºèªï¼šæ­¤æ“ä½œä¸å¯é‚„åŸï¼çœŸçš„è¦é‡ç½®å—ï¼Ÿ")) return;
      google.script.run.withSuccessHandler(res => {
        alert(res.message);
        location.reload();
      }).resetSystem();
    }
  </script>
</body>
</html>
