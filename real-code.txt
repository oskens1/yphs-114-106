// ==========================================
// è¨­å®šå€
// ==========================================
const SHEET_STUDENT = "StudentData";
const SHEET_LOGS = "PointLogs";
const SHEET_AUCTIONS = "Auctions";
const SHEET_ADMIN = "Admin";
const SHEET_BIDS = "BidLogs";

function doGet(e) {
  const action = e.parameter.action;
  const callback = e.parameter.callback;

  if (callback) {
    let res;
    if (action === 'login') {
      res = studentLogin(e.parameter.seat, e.parameter.pwd);
    } else if (action === 'getLogs') {
      res = getStudentLogs(e.parameter.seat);
    } else if (action === 'getAuctions') {
      res = getActiveAuctions();
    } else if (action === 'submitBid') {
      res = submitBid(e.parameter.seat, e.parameter.name, e.parameter.auctionId, e.parameter.auctionName, e.parameter.bidPrice);
    }
    
    if (res !== undefined) {
      return ContentService.createTextOutput(callback + '(' + JSON.stringify(res) + ')')
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
  }

  // é è¨­è¡Œç‚ºï¼šé¡¯ç¤ºæ¬å®¶é€šçŸ¥
  const moveHtml = `
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8">
        <title>ç³»çµ±æ¬å®¶é€šçŸ¥</title>
        <style>
          body { font-family: sans-serif; text-align: center; padding: 50px; background: #f8f9fa; }
          .card { background: white; padding: 30px; border-radius: 10px; display: inline-block; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
          .btn { background: #764ba2; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; }
        </style>
      </head>
      <body>
        <div class="card">
          <h2>ğŸš€ 106ç­ç©åˆ†éŠ€è¡Œå·²å‡ç´š</h2>
          <p>ç‚ºäº†æä¾›æ›´å¥½çš„ä½¿ç”¨é«”é©—ï¼Œç³»çµ±å·²æ¬é·è‡³æ–°ç¶²å€ã€‚</p>
          <br><br>
          <a href="https://yphs-114-106.vercel.app/" class="btn">å‰å¾€æ–°ç‰ˆç³»çµ±</a>
          <br><br><br>
          <small style="color:#888">è«‹æ›´æ–°æ‚¨çš„æ›¸ç±¤</small>
        </div>
      </body>
    </html>
  `;
  return HtmlService.createHtmlOutput(moveHtml)
    .setTitle('ç³»çµ±æ¬å®¶é€šçŸ¥')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

// è€å¸«ç«¯ï¼šæ‰¹æ¬¡åŠ åˆ†
function processBulkAdd() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();
  const adminSheet = ss.getSheetByName(SHEET_ADMIN);
  const logSheet = ss.getSheetByName(SHEET_LOGS);
  const studentSheet = ss.getSheetByName(SHEET_STUDENT);
  const reason = adminSheet.getRange("B2").getValue();
  const score = adminSheet.getRange("D2").getValue();
  if (reason === "" || score === "") { ui.alert("éŒ¯èª¤ï¼šè«‹è¼¸å…¥äº‹ç”±èˆ‡åˆ†æ•¸"); return; }
  const lastRow = adminSheet.getLastRow();
  if (lastRow < 6) return;
  const range = adminSheet.getRange(6, 1, lastRow - 5, 3);
  const values = range.getValues();
  const timestamp = new Date();
  let processCount = 0;
  let newLogs = [];
  let scoreMap = {};
  values.forEach((row, index) => {
    if (row[0] === true || row[0] === "true") {
      processCount++;
      newLogs.push([timestamp, row[1], row[2], reason, score]);
      scoreMap[row[1]] = score;
      values[index][0] = false;
    }
  });
  if (processCount === 0) { ui.alert("æœªå‹¾é¸ä»»ä½•å­¸ç”Ÿ"); return; }
  if (newLogs.length > 0) logSheet.getRange(logSheet.getLastRow() + 1, 1, newLogs.length, 5).setValues(newLogs);
  updateStudentScores(studentSheet, scoreMap);
  range.setValues(values);
  ui.alert(`å®Œæˆï¼å·²å¹« ${processCount} ä½åŒå­¸åŸ·è¡Œæ“ä½œã€‚`);
}

function updateStudentScores(sheet, scoreMap) {
  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return;
  const range = sheet.getRange(2, 1, lastRow - 1, 5);
  const data = range.getValues();
  let isUpdated = false;
  for (let i = 0; i < data.length; i++) {
    const seat = data[i][1];
    if (scoreMap[seat] !== undefined) {
      const current = data[i][4] === "" ? 0 : data[i][4];
      data[i][4] = Number(current) + Number(scoreMap[seat]);
      isUpdated = true;
    }
  }
  if (isUpdated) range.setValues(data);
}

// å­¸ç”Ÿç«¯ï¼šç™»å…¥
function studentLogin(seat, password) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_STUDENT);
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][1]) === String(seat) && (password === '' || String(data[i][3]) === String(password))) {
      return { success: true, name: data[i][2], score: data[i][4], seat: data[i][1] };
    }
  }
  return { success: false, message: "åº§è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤" };
}

// å­¸ç”Ÿç«¯ï¼šç²å–ç´€éŒ„
function getStudentLogs(seat) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_LOGS);
  if (sheet.getLastRow() < 2) return [];
  const data = sheet.getRange(2, 1, sheet.getLastRow()-1, 5).getValues();
  return data.filter(row => String(row[1]) === String(seat)).map(row => ({
    time: formatDate(row[0]), reason: row[3], score: row[4]
  })).reverse();
}

// å­¸ç”Ÿç«¯ï¼šç²å–ç«¶æ¨™å•†å“
function getActiveAuctions() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_AUCTIONS);
  if (sheet.getLastRow() < 2) return [];
  const data = sheet.getRange(2, 1, sheet.getLastRow()-1, 8).getValues();
  const now = new Date();
  return data.filter(row => row[5] === "é€²è¡Œä¸­" && new Date(row[4]) > now).map(row => {
    const currentPrice = (row[6] === "" || row[6] === null) ? row[3] : row[6];
    return { id: row[0], name: row[1], img: row[2], startPrice: row[3], currentPrice: currentPrice, leader: row[7] ? row[7] : "å°šç„¡", deadline: formatDate(row[4]) };
  });
}

// å­¸ç”Ÿç«¯ï¼šå‡ºåƒ¹
function submitBid(seat, name, auctionId, auctionName, bidPrice) {
  const lock = LockService.getScriptLock();
  try {
    lock.waitLock(5000); 
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const auctionSheet = ss.getSheetByName(SHEET_AUCTIONS);
    const studentSheet = ss.getSheetByName(SHEET_STUDENT);
    const bidSheet = ss.getSheetByName(SHEET_BIDS);
    const auctions = auctionSheet.getDataRange().getValues();
    let targetRowIndex = -1;
    let targetCurrentMax = 0;
    let lockedScore = 0;
    for(let i=1; i<auctions.length; i++){
      const rowId = String(auctions[i][0]);
      const rowStatus = auctions[i][5];
      const rowPrice = Number(auctions[i][6] || auctions[i][3]);
      const rowLeader = String(auctions[i][7]);
      if(rowId === String(auctionId)){ targetRowIndex = i + 1; targetCurrentMax = rowPrice; }
      if(rowStatus === "é€²è¡Œä¸­" && rowLeader === String(name) && rowId !== String(auctionId)) { lockedScore += rowPrice; }
    }
    if(targetRowIndex === -1) return {success: false, message: "æ‰¾ä¸åˆ°å•†å“"};
    if (Number(bidPrice) <= Number(targetCurrentMax)) return {success: false, message: `å‡ºåƒ¹å¤ªæ…¢ï¼ç›®å‰å·²é” ${targetCurrentMax}`};
    const students = studentSheet.getDataRange().getValues();
    let totalScore = 0;
    for(let i=1; i<students.length; i++){
      if(String(students[i][1]) === String(seat)){ totalScore = Number(students[i][4]); break; }
    }
    if (Number(bidPrice) > (totalScore - lockedScore)) return {success: false, message: "ç©åˆ†ä¸è¶³ (å«å‡çµ)"};
    auctionSheet.getRange(targetRowIndex, 7).setValue(bidPrice);
    auctionSheet.getRange(targetRowIndex, 8).setValue(name); 
    bidSheet.appendRow([new Date(), auctionId, auctionName, seat, name, bidPrice]);
    return {success: true, message: "ğŸ‰ å‡ºåƒ¹æˆåŠŸï¼"};
  } catch (e) { return { success: false, message: "ç³»çµ±éŒ¯èª¤: " + e.message }; } finally { lock.releaseLock(); }
}

function formatDate(dateObj) {
  if (!dateObj) return "";
  const d = new Date(dateObj);
  return (d.getMonth()+1) + "/" + d.getDate() + " " + d.getHours() + ":" + (d.getMinutes()<10?'0':'') + d.getMinutes();
}