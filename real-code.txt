// ==========================================
// è¨­å®šå€
// ==========================================
const SHEET_STUDENT = "StudentData";
const SHEET_LOGS = "PointLogs";
const SHEET_AUCTIONS = "Auctions";
const SHEET_ADMIN = "Admin";
const SHEET_BIDS = "BidLogs";

function doGet(e) {
  const action = e.parameter.action;
  const callback = e.parameter.callback;

  if (action === 'login') {
    const res = studentLogin(e.parameter.seat, e.parameter.pwd);
    return ContentService.createTextOutput(callback + '(' + JSON.stringify(res) + ')')
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
  
  if (action === 'getLogs') {
    const res = getStudentLogs(e.parameter.seat);
    return ContentService.createTextOutput(callback + '(' + JSON.stringify(res) + ')')
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }

  // é è¨­è¡Œç‚ºï¼šè¿”å› HTML ä»‹é¢ (ç”¨æ–¼ Google å…§éƒ¨è¨ªå•)
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setTitle('ç­ç´šç©åˆ†éŠ€è¡Œ')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
>>>>+++ REPLACE


// è€å¸«ç«¯ï¼šæ‰¹æ¬¡åŠ åˆ† (ç¶­æŒä¸è®Š)
function processBulkAdd() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();
  const adminSheet = ss.getSheetByName(SHEET_ADMIN);
  const logSheet = ss.getSheetByName(SHEET_LOGS);
  const studentSheet = ss.getSheetByName(SHEET_STUDENT);
  
  const reason = adminSheet.getRange("B2").getValue();
  const score = adminSheet.getRange("D2").getValue();
  
  if (reason === "" || score === "") { ui.alert("éŒ¯èª¤ï¼šè«‹è¼¸å…¥äº‹ç”±èˆ‡åˆ†æ•¸"); return; }
  
  const lastRow = adminSheet.getLastRow();
  if (lastRow < 6) return;
  
  const range = adminSheet.getRange(6, 1, lastRow - 5, 3);
  const values = range.getValues();
  
  const timestamp = new Date();
  let processCount = 0;
  let newLogs = [];
  let scoreMap = {};

  values.forEach((row, index) => {
    if (row[0] === true || row[0] === "true") {
      processCount++;
      newLogs.push([timestamp, row[1], row[2], reason, score]);
      scoreMap[row[1]] = score;
      values[index][0] = false;
    }
  });
  
  if (processCount === 0) { ui.alert("æœªå‹¾é¸ä»»ä½•å­¸ç”Ÿ"); return; }
  
  if (newLogs.length > 0) logSheet.getRange(logSheet.getLastRow() + 1, 1, newLogs.length, 5).setValues(newLogs);
  updateStudentScores(studentSheet, scoreMap);
  range.setValues(values);
  ui.alert(`å®Œæˆï¼å·²å¹« ${processCount} ä½åŒå­¸åŸ·è¡Œæ“ä½œã€‚`);
}

function updateStudentScores(sheet, scoreMap) {
  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return;
  const range = sheet.getRange(2, 1, lastRow - 1, 5);
  const data = range.getValues();
  let isUpdated = false;
  for (let i = 0; i < data.length; i++) {
    const seat = data[i][1];
    if (scoreMap[seat] !== undefined) {
      const current = data[i][4] === "" ? 0 : data[i][4];
      data[i][4] = Number(current) + Number(scoreMap[seat]);
      isUpdated = true;
    }
  }
  if (isUpdated) range.setValues(data);
}

// å­¸ç”Ÿç«¯ï¼šç™»å…¥ (ç¶­æŒä¸è®Š)
function studentLogin(seat, password) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_STUDENT);
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][1]) === String(seat) && String(data[i][3]) === String(password)) {
      return { success: true, name: data[i][2], score: data[i][4], seat: data[i][1] };
    }
  }
  return { success: false, message: "åº§è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤" };
}

// å­¸ç”Ÿç«¯ï¼šç²å–ç´€éŒ„ (ç¶­æŒä¸è®Š)
function getStudentLogs(seat) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_LOGS);
  if (sheet.getLastRow() < 2) return [];
  const data = sheet.getRange(2, 1, sheet.getLastRow()-1, 5).getValues();
  return data.filter(row => String(row[1]) === String(seat)).map(row => ({
    time: formatDate(row[0]), reason: row[3], score: row[4]
  })).reverse();
}

// å­¸ç”Ÿç«¯ï¼šç²å–ç«¶æ¨™å•†å“ (æœ‰ä¿®æ”¹ï¼šéœ€å›å‚³ç›®å‰æœ€é«˜åƒ¹)
function getActiveAuctions() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_AUCTIONS);
  if (sheet.getLastRow() < 2) return [];
  
  // è®€å–åˆ° H æ¬„ (A~H)
  const data = sheet.getRange(2, 1, sheet.getLastRow()-1, 8).getValues();
  const now = new Date();
  
  // æ¬„ä½: A=ID, B=Name, C=Img, D=StartPrice, E=Deadline, F=Status, G=CurrentPrice, H=Leader
  return data.filter(row => row[5] === "é€²è¡Œä¸­" && new Date(row[4]) > now).map(row => {
    // å¦‚æœç›®å‰æœ€é«˜åƒ¹(G)æ˜¯ç©ºçš„ï¼Œå°±é¡¯ç¤ºèµ·æ¨™åƒ¹(D)
    const currentPrice = (row[6] === "" || row[6] === null) ? row[3] : row[6];
    return {
      id: row[0],
      name: row[1],
      img: row[2],
      startPrice: row[3],
      currentPrice: currentPrice, // é€™æ˜¯é‡é»
      leader: row[7] ? row[7] : "å°šç„¡", // ç›®å‰è´å®¶
      deadline: formatDate(row[4]),
      desc: row[6] // æ³¨æ„ï¼šè‹¥ä½ æ¬„ä½ä½ç§»ï¼Œèªªæ˜æ¬„ä½å¯èƒ½è·‘åˆ° Iï¼Œè«‹ç¢ºèªä½ çš„è¡¨æ ¼çµæ§‹ï¼Œé€™è£¡å‡è¨­èªªæ˜åœ¨ G ä¹‹å¾Œ
    };
  });
}

// å­¸ç”Ÿç«¯ï¼šå‡ºåƒ¹ (å¤§å¹…ä¿®æ”¹ï¼šå…¬é–‹ç«¶æ¨™é‚è¼¯ + é–å®šæ©Ÿåˆ¶)
// å­¸ç”Ÿç«¯ï¼šå‡ºåƒ¹ (æ”¹è‰¯ç‰ˆï¼šåŠ å…¥è©³ç´°éŒ¯èª¤æ•æ‰èˆ‡é˜²å¡æ­»)
// å­¸ç”Ÿç«¯ï¼šå‡ºåƒ¹ (æœ€çµ‚å¼·åŒ–ç‰ˆï¼šåŠ å…¥ã€Œå‡çµé ç®—ã€æª¢æŸ¥ï¼Œé˜²æ­¢ç ´ç”¢)
function submitBid(seat, name, auctionId, auctionName, bidPrice) {
  const lock = LockService.getScriptLock();
  
  try {
    lock.waitLock(5000); 
  } catch (e) {
    return { success: false, message: "ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹å†è©¦ä¸€æ¬¡" };
  }

  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const auctionSheet = ss.getSheetByName(SHEET_AUCTIONS);
    const studentSheet = ss.getSheetByName(SHEET_STUDENT);
    const bidSheet = ss.getSheetByName(SHEET_BIDS);

    if (!auctionSheet || !studentSheet || !bidSheet) throw new Error("è³‡æ–™åº«åˆ†é è®€å–å¤±æ•—");

    // 1. å–å¾—æ‰€æœ‰å•†å“è³‡æ–™
    const auctions = auctionSheet.getDataRange().getValues();
    
    // 2. æ‰¾å‡ºã€Œç›®æ¨™å•†å“ã€çš„è³‡æ–™ & è¨ˆç®—è©²å­¸ç”Ÿã€Œåœ¨å…¶ä»–å•†å“çš„å‡çµè³‡é‡‘ã€
    let targetRowIndex = -1;
    let targetCurrentMax = 0;
    let lockedScore = 0; // å‡çµè³‡é‡‘

    // å¾ç¬¬1åˆ—(æ¨™é¡Œå¾Œ)é–‹å§‹æƒæ
    for(let i=1; i<auctions.length; i++){
      const rowId = String(auctions[i][0]);       // Aæ¬„ ID
      const rowStatus = auctions[i][5];           // Fæ¬„ ç‹€æ…‹
      const rowPrice = Number(auctions[i][6] || auctions[i][3]); // Gæ¬„ ç›®å‰åƒ¹ (è‹¥ç„¡å‰‡å– Dæ¬„ èµ·æ¨™)
      const rowLeader = String(auctions[i][7]);   // Hæ¬„ é ˜å…ˆè€…å§“å

      // å¦‚æœæ˜¯ã€Œç›®æ¨™å•†å“ã€
      if(rowId === String(auctionId)){
        targetRowIndex = i + 1;
        targetCurrentMax = rowPrice;
      }
      
      // å¦‚æœæ˜¯ã€Œå…¶ä»–ã€æ­£åœ¨é€²è¡Œä¸­çš„å•†å“ï¼Œä¸”é ˜å…ˆè€…æ˜¯é€™ä½åŒå­¸ -> ç´¯åŠ å‡çµè³‡é‡‘
      // æ³¨æ„ï¼šrowId != auctionId ä»£è¡¨ã€Œä¸åŒ…å«ç¾åœ¨æ­£è¦æ¨™çš„é€™ä¸€å€‹ã€(å› ç‚ºå¦‚æœæ˜¯è‡ªå·±åŠ ç¢¼ï¼Œåªè¦ä»˜å·®é¡ï¼Œæˆ–æ˜¯è¦–ç‚ºé‡æ–°å‡ºåƒ¹)
      if(rowStatus === "é€²è¡Œä¸­" && rowLeader === String(name) && rowId !== String(auctionId)) {
        lockedScore += rowPrice;
      }
    }

    if(targetRowIndex === -1) return {success: false, message: "æ‰¾ä¸åˆ°è©²å•†å“ï¼Œå¯èƒ½å·²ä¸‹æ¶"};

    // 3. æª¢æŸ¥å‡ºåƒ¹æ˜¯å¦é«˜æ–¼ç›®å‰åƒ¹æ ¼
    if (Number(bidPrice) <= Number(targetCurrentMax)) {
      return {success: false, message: `å‡ºåƒ¹å¤±æ•—ï¼æ…¢äº†ä¸€æ­¥ï¼Œç›®å‰æœ€é«˜åƒ¹å·²ç¶“æ˜¯ ${targetCurrentMax} äº†`};
    }

    // 4. æª¢æŸ¥ã€ŒçœŸå¯¦å¯ç”¨é¤˜é¡ã€
    const students = studentSheet.getDataRange().getValues();
    let totalScore = 0;
    let foundStudent = false;
    
    for(let i=1; i<students.length; i++){
      if(String(students[i][1]) === String(seat)){
         totalScore = Number(students[i][4]);
         foundStudent = true;
         break;
      }
    }
    
    if (!foundStudent) throw new Error("æ‰¾ä¸åˆ°å­¸ç”Ÿè³‡æ–™");

    // è¨ˆç®—å¯ç”¨é¤˜é¡
    const availableScore = totalScore - lockedScore;

    if (Number(bidPrice) > availableScore) {
      return {
        success: false, 
        message: `ç©åˆ†ä¸è¶³ï¼\nä½ çš„ç¸½åˆ†: ${totalScore}\nå…¶ä»–ç«¶æ¨™ä¿ç•™æ¬¾: ${lockedScore}\nå‰©é¤˜å¯ç”¨: ${availableScore}\n(ä½ éœ€è¦ ${bidPrice})`
      };
    }

    // 5. å¯«å…¥å‡ºåƒ¹
    auctionSheet.getRange(targetRowIndex, 7).setValue(bidPrice);
    auctionSheet.getRange(targetRowIndex, 8).setValue(name); 
    bidSheet.appendRow([new Date(), auctionId, auctionName, seat, name, bidPrice]);

    return {success: true, message: "ğŸ‰ å‡ºåƒ¹æˆåŠŸï¼ä½ æ˜¯ç›®å‰çš„æœ€é«˜å‡ºåƒ¹è€…ï¼"};

  } catch (error) {
    return { success: false, message: "ç³»çµ±éŒ¯èª¤: " + error.message };
  } finally {
    lock.releaseLock();
  }
}
function formatDate(dateObj) {
  if (!dateObj) return "";
  const d = new Date(dateObj);
  return (d.getMonth()+1) + "/" + d.getDate() + " " + d.getHours() + ":" + (d.getMinutes()<10?'0':'') + d.getMinutes();
}